<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="学校の年間行事予定表をExcelファイルから読み込み、JSON・ICAL形式でエクスポートできるWebアプリケーション">
    <title>年間行事予定表アプリ - スケジュール管理ツール</title>

    <!-- Stylesheet -->
    <link rel="stylesheet" href="styles.css">

    <!-- External Libraries (Local versions for offline support) -->
    <script src="xlsx.full.min.js"></script>
    <script src="exceljs.min.js"></script>
    <script src="pizzip.js"></script>
    <script src="docxtemplater.js"></script>
    <script src="work_settings.js"></script>
</head>

<body>
    <header class="app-header-compact">
        <div class="header-content">
            <div class="header-left">
                <button id="menuToggleBtn" class="menu-btn" title="メニューを開く">
                    <span class="hamburger-icon"></span>
                </button>
                <h1>📅 <span>年間行事予定表アプリ</span></h1>
            </div>
            <div class="header-right">
                <div class="year-selector">
                    <label for="globalYearSelect">年度:</label>
                    <select id="globalYearSelect" class="year-select">
                        <!-- JSで生成 -->
                    </select>
                </div>
            </div>
        </div>
    </header>

    <div class="app-container">

        <!-- サイドメニュー (ドロワー) -->
        <div id="sideDrawer" class="side-drawer">
            <div class="drawer-header">
                <h3>メニュー</h3>
                <button id="closeDrawerBtn" class="close-btn">&times;</button>
            </div>
            <nav class="drawer-nav">
                <button data-view="calendarView" class="drawer-item active">
                    <span class="nav-icon">📅</span>
                    <span class="nav-label">カレンダー</span>
                </button>
                <button data-view="importContainer" class="drawer-item">
                    <span class="nav-icon">📁</span>
                    <span class="nav-label">ファイル操作</span>
                </button>
                <button data-view="exportSection" class="drawer-item">
                    <span class="nav-icon">📤</span>
                    <span class="nav-label">エクスポート</span>
                </button>
                <button data-view="myClassesSection" class="drawer-item">
                    <span class="nav-icon">📖</span>
                    <span class="nav-label">授業設定</span>
                </button>
                <button data-view="settingsSection" class="drawer-item">
                    <span class="nav-icon">⚙️</span>
                    <span class="nav-label">各種設定</span>
                </button>
                <button data-view="workSection" class="drawer-item">
                    <span class="nav-icon">⌛</span>
                    <span class="nav-label">勤務設定</span>
                </button>
                <button data-view="statsView" class="drawer-item">
                    <span class="nav-icon">📊</span>
                    <span class="nav-label">勤怠管理</span>
                </button>
                <button data-view="profileSection" class="drawer-item">
                    <span class="nav-icon">👤</span>
                    <span class="nav-label">あなたについて</span>
                </button>
                <button data-view="helpSection" class="drawer-item">
                    <span class="nav-icon">❓</span>
                    <span class="nav-label">使い方</span>
                </button>
            </nav>
            <div class="drawer-footer">
                <p>&copy; 2026 Annual Schedule App</p>
            </div>
        </div>
        <div id="drawerOverlay" class="drawer-overlay"></div>


        <!-- カレンダー表示 (デフォルト表示) -->
        <div id="calendarView">
            <!-- カレンダー本体 -->
            <section id="calendarSection" class="card">
                <div class="calendar-header"
                    style="display: flex; gap: 15px; align-items: center; justify-content: space-between; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button class="btn btn-secondary btn-sm" id="prevMonthBtn" title="前の月に移動します">◀</button>
                        <button class="btn btn-primary btn-today btn-sm" id="todayBtn" title="今日の月へ移動し、ハイライト表示します"
                            style="font-weight: 700;">今日</button>
                        <button class="btn btn-secondary btn-sm" id="nextMonthBtn" title="次の月に移動します">▶</button>
                    </div>

                    <h3 class="calendar-title" id="calendarTitle"
                        style="margin: 0; flex: 1; text-align: center; min-width: 150px;">2026年 4月</h3>

                    <div
                        style="display: flex; align-items: center; gap: 12px; background: var(--neutral-50); padding: 5px 12px; border-radius: var(--radius-md); border: 1px solid var(--neutral-200);">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <label for="monthSelect"
                                style="font-size: 0.8rem; font-weight: 700; color: var(--neutral-600); white-space: nowrap;">表示月:</label>
                            <select id="monthSelect" class="control-select"
                                style="padding: 3px 6px; font-size: 0.85rem; width: auto; height: auto; border-color: var(--neutral-300);"></select>
                        </div>
                        <div style="height: 15px; width: 1px; background: var(--neutral-300);"></div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <label for="targetSelect"
                                style="font-size: 0.8rem; font-weight: 700; color: var(--neutral-600); white-space: nowrap;">曜日カウント:</label>
                            <select id="targetSelect" class="control-select"
                                style="padding: 3px 6px; font-size: 0.85rem; width: auto; height: auto; border-color: var(--neutral-300);">
                                <option value="both">バッチあり</option>
                                <option value="teacher">バッチなし</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="calendar-grid" id="calendarGrid">
                    <!-- カレンダーはJavaScriptで動的生成 -->
                </div>
            </section>
        </div>

        <!-- 年間行事データ管理 (デフォルト非表示) -->
        <div id="importContainer" class="hidden">
            <!-- ファイルアップロードセクション -->
            <section class="card">
                <div class="card-header">
                    <div class="card-icon">&#x1F4C1;</div>
                    <h2>Excelファイルの読み込み</h2>
                </div>

                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">&#x1F4E4;</div>
                    <div class="upload-text">ファイルをドラッグ&ドロップ</div>
                    <div class="upload-hint">または クリックしてファイルを選択</div>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
                </div>

                <!-- データ操作アクション (常に表示) -->
                <div class="data-actions-container"
                    style="margin-top: 20px; padding: 15px; background: var(--neutral-50); border-radius: var(--radius-md); border: 1px solid var(--neutral-200);">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                        <div style="font-weight: 600; color: var(--neutral-700);">
                            <span style="margin-right: 5px;">&#x1F4BE;</span> データ管理
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-outline-primary btn-sm" onclick="downloadBackup()"
                                title="現在の全データをJSON形式で保存">
                                <span>&#x1F4E4; バックアップ</span>
                            </button>
                            <button class="btn btn-outline-primary btn-sm"
                                onclick="document.getElementById('backupFileInput').click()" title="保存したJSONから復元">
                                <span>&#x1F4E5; 復旧</span>
                            </button>
                            <button id="clearDataBtn" class="btn btn-outline-danger btn-sm"
                                onclick="clearScheduleData()">
                                <span>&#x1F5D1;️ 全クリア</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="fileSelected" class="file-selected hidden"
                    style="background: var(--primary-blue-light); border: 1px solid var(--primary-blue);">
                    <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                        <span style="color: var(--primary-blue); font-weight: bold;">✓ 最終取込:</span>
                        <strong id="fileName"></strong>
                        <span id="fileSize" style="font-size: 0.85rem; color: var(--neutral-600);"></span>
                    </div>
                </div>

                <!-- 読み込み済み年度の管理リスト -->
                <div id="cachedYearsContainer" class="mt-lg hidden"
                    style="border-top: 1px solid var(--neutral-200); padding-top: 15px;">
                    <h3 style="font-size: 0.95rem; margin-bottom: 10px; color: var(--neutral-600);">&#x1F4CA;
                        読み込み済みの年度データ</h3>
                    <div class="table-container">
                        <table class="manage-table" style="font-size: 0.85rem;">
                            <thead>
                                <tr>
                                    <th>年度</th>
                                    <th>読み込み元</th>
                                    <th>取込日</th>
                                    <th class="text-center">総日数</th>
                                    <th class="text-center">本科行事</th>
                                    <th class="text-center">専攻科/備考</th>
                                    <th class="text-center">授業日</th>
                                    <th style="width: 70px;">操作</th>
                                </tr>
                            </thead>
                            <tbody id="cachedYearsBody">
                                <!-- JSで動的生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- バックアップ/復元セクション -->
                <div style="margin-top: 30px; border-top: 2px solid var(--neutral-200); padding-top: 20px;">
                    <section class="card-inner"
                        style="background: var(--neutral-50); border: 1px solid var(--neutral-200); border-radius: var(--radius-md); padding: 20px;">
                        <div class="card-header" style="margin-bottom: 15px;">
                            <div class="card-icon" style="font-size: 1.2rem;">&#x1F4BE;</div>
                            <h2 style="font-size: 1.1rem; margin: 0;">バックアップ・復元管理</h2>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <!-- バックアップ -->
                            <div
                                style="border: 1px solid var(--neutral-200); border-radius: 8px; padding: 15px; background: white;">
                                <h3 style="margin-top: 0; font-size: 1rem; color: var(--success-600);">&#x1F4E4;
                                    バックアップを保存</h3>
                                <p style="font-size: 0.85rem; color: var(--neutral-600); margin: 8px 0 12px;">
                                    現在のすべてのデータをJSONファイルで保存します
                                </p>
                                <div class="form-group" style="margin-bottom: 8px;">
                                    <label class="form-label" for="backupTypeSelect">バックアップ対象:</label>
                                    <select id="backupTypeSelect" class="form-select" style="padding: 6px;"
                                        title="保存するデータの範囲を選択します">
                                        <option value="all">全データ（スケジュール＋授業＋設定）</option>
                                        <option value="schedule">スケジュールのみ</option>
                                        <option value="classes">授業登録のみ</option>
                                        <option value="settings">設定のみ</option>
                                    </select>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-success" onclick="saveAllToLocalExplicit()"
                                        style="flex: 1; padding: 10px;" data-tooltip="編集内容をブラウザに保存">
                                        &#x1F4BE; 保存
                                    </button>
                                    <button class="btn btn-outline-success" onclick="downloadSelectiveBackup()"
                                        style="flex: 1; padding: 10px;" data-tooltip="JSON形式でファイル出力">
                                        &#x1F4E4; 出力
                                    </button>
                                </div>
                            </div>

                            <!-- 復元 -->
                            <div
                                style="border: 1px solid var(--neutral-200); border-radius: 8px; padding: 15px; background: white;">
                                <h3 style="margin-top: 0; font-size: 1rem; color: var(--primary-600);">&#x1F4E5;
                                    バックアップから復元</h3>
                                <p style="font-size: 0.85rem; color: var(--neutral-600); margin: 8px 0 12px;">
                                    保存したバックアップファイルを選択して復元します
                                </p>
                                <div class="form-group" style="margin-bottom: 8px;">
                                    <label class="form-label" for="restoreTypeSelect">復元対象:</label>
                                    <select id="restoreTypeSelect" class="form-select" style="padding: 6px;"
                                        title="復元する方法（上書きか追加か）を選択します">
                                        <option value="all">全データを復元</option>
                                        <option value="schedule">スケジュールのみ復元</option>
                                        <option value="classes">授業登録のみ復元</option>
                                        <option value="settings">設定のみ復元</option>
                                        <option value="merge">現在のデータにマージ</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary btn-block"
                                    onclick="document.getElementById('backupFileInput').click()"
                                    style="width: 100%; padding: 10px;">
                                    &#x1F4C2; ファイルを選択
                                </button>
                            </div>
                        </div>

                        <!-- バックアップ履歴 -->
                        <div style="border-top: 1px solid var(--neutral-200); padding-top: 15px;">
                            <h3 style="font-size: 0.9rem; margin-bottom: 12px; color: var(--neutral-700);">&#x1F4CB;
                                バックアップ情報
                            </h3>
                            <div id="backupInfoContainer"
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                                <div
                                    style="background: white; padding: 10px; border-radius: 6px; border-left: 3px solid var(--primary-500); border: 1px solid var(--neutral-200);">
                                    <div style="font-size: 0.75rem; color: var(--neutral-600);">最後のバックアップ</div>
                                    <div id="lastBackupTime"
                                        style="font-weight: bold; margin-top: 4px; font-size: 0.85rem;">未保存</div>
                                </div>
                                <div
                                    style="background: white; padding: 10px; border-radius: 6px; border-left: 3px solid var(--success-500); border: 1px solid var(--neutral-200);">
                                    <div style="font-size: 0.75rem; color: var(--neutral-600);">スケジュール件数</div>
                                    <div id="scheduleCountInfo"
                                        style="font-weight: bold; margin-top: 4px; font-size: 0.85rem;">0件</div>
                                </div>
                                <div
                                    style="background: white; padding: 10px; border-radius: 6px; border-left: 3px solid var(--secondary-purple); border: 1px solid var(--neutral-200);">
                                    <div style="font-size: 0.75rem; color: var(--neutral-600);">授業登録件数</div>
                                    <div id="classesCountInfo"
                                        style="font-weight: bold; margin-top: 4px; font-size: 0.85rem;">0件</div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </section>
        </div>



        <!-- エクスポートセクション -->
        <section id="exportSection" class="card hidden">
            <div class="card-header">
                <div class="card-icon">&#x1F4BE;</div>
                <h2>エクスポート</h2>
            </div>

            <div class="export-controls"
                style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                <h3 style="margin-top: 0; margin-bottom: 10px; font-size: 1rem;">期間指定</h3>
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="exportStartDate" style="font-size: 0.9rem;">開始日</label>
                        <input type="date" id="exportStartDate" class="form-input" style="padding: 5px;">
                    </div>
                    <span style="align-self: flex-end; margin-bottom: 5px;">～</span>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="exportEndDate" style="font-size: 0.9rem;">終了日</label>
                        <input type="date" id="exportEndDate" class="form-input" style="padding: 5px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0; margin-left: 10px;">
                        <label style="font-size: 0.9rem; display: block; margin-bottom: 5px;">出力内容</label>
                        <div
                            style="display: flex; gap: 12px; font-size: 0.85rem; background: white; padding: 4px 10px; border-radius: 4px; border: 1px solid var(--neutral-300);">
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input
                                    type="checkbox" id="exportAnnual" checked> 年間行事</label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input
                                    type="checkbox" id="exportClass" checked> 授業予定</label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input
                                    type="checkbox" id="exportApplied" checked> 申請予定</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="export-section">
                <div class="export-card">
                    <div class="export-icon">&#x1F4CB;</div>
                    <h3>JSON形式</h3>
                    <p>プログラムで処理しやすいJSON形式で出力</p>
                    <button class="btn btn-success" id="exportJsonBtn"
                        title="データをJSON形式でダウンロードします。他の端末への移行やシステム連携に利用できます。">
                        <span>JSON出力</span>
                    </button>
                </div>

                <div class="export-card">
                    <div class="export-icon">&#x1F4C5;</div>
                    <h3>ICAL形式</h3>
                    <p>GoogleカレンダーやOutlookで利用可能</p>
                    <button class="btn btn-warning" id="exportIcalBtn"
                        title="カレンダー形式(iCal)で出力します。GoogleカレンダーやiPhone等で読み込めます。">
                        <span>ICAL出力</span>
                    </button>
                </div>

                <div class="export-card">
                    <div class="export-icon">&#x1F4C4;</div>
                    <h3>CSV形式</h3>
                    <p>表計算ソフトで編集可能なCSV形式</p>
                    <button class="btn btn-primary" id="exportCsvBtn" title="Excel等の表計算ソフトで編集可能な形式で出力します。">
                        <span>CSV出力</span>
                    </button>
                </div>
            </div>
        </section>


    </div>

    <!-- 授業登録セクション (デフォルト非表示) -->
    <section id="myClassesSection" class="card hidden">
        <div class="card-header">
            <div class="card-icon">&#x1F4D6;</div>
            <h2>自分の授業登録</h2>
        </div>

        <!-- 時間割表 -->
        <div class="timetable-section" style="margin-top: 0; padding-top: 0; border-top: none;">
            <div class="timetable-header">
                <h3 class="form-section-title" id="timetableTitle">&#x1F4C6; あなたの時間割</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div class="timetable-switcher">
                        <button class="active" onclick="switchTimetableSemester('first')"
                            title="前期の時間割を表示します">前期</button>
                        <button onclick="switchTimetableSemester('second')" title="後期の時間割を表示します">後期</button>
                    </div>
                </div>
            </div>
            <div class="timetable-grid" id="timetableGrid">
                <!-- JSで生成 -->
            </div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button class="btn btn-primary btn-lg" onclick="openClassInputModal()" title="新しい自コマ（自分の授業）を登録します">
                <span>➕ 授業を追加</span>
            </button>
        </div>

        <!-- 登録済み授業リスト -->
        <div class="registered-classes">
            <div class="registered-header">
                <h3>登録済み授業（<span id="classCount">0</span>件）</h3>
                <button id="showClassScheduleBtn" class="btn btn-secondary btn-sm" title="登録した授業の年間日程を一覧で確認します">
                    <span>&#x1F4C5; 日程表を表示</span>
                </button>
                <button id="showVacationCandidatesBtn" class="btn btn-success btn-sm"
                    title="年休の候補日（予定のない営業日）を抽出して一覧表示します">
                    <span>&#x1F3D6;️ 年休候補日を抽出</span>
                </button>
            </div>
            <div id="classList" class="class-list">
                <p class="empty-message">まだ授業が登録されていません</p>
            </div>
        </div>
    </section>

    <!-- 各種設定セクション (デフォルト非表示) -->
    <section id="settingsSection" class="card hidden">
        <div class="card-header">
            <div class="card-icon">⚙️</div>
            <h2>各種設定・管理</h2>
        </div>

        <div class="settings-tabs">
            <button id="tabManageCourses" class="settings-tab active" onclick="switchSettingsTab('courses')">&#x1F4DA;
                授業候補の修正</button>
            <button id="tabManageTeachers" class="settings-tab" onclick="switchSettingsTab('teachers')">&#x1F464;
                教員リスト管理</button>
        </div>


        <div id="settingsCoursesView" class="settings-tab-content">
            <div class="settings-action-bar"
                style="display: flex; flex-direction: column; gap: 10px; align-items: stretch;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>授業候補（サジェスト）のマスター管理</h3>
                    <button class="btn btn-primary btn-sm" onclick="openCourseEditModal()"
                        title="授業入力時に選択肢として表示される授業名を追加します">➕ 候補授業を追加</button>
                </div>
                <div class="search-box">
                    <input type="text" id="courseMasterSearch" class="form-input" placeholder="授業名で検索..."
                        oninput="renderManageCourses()" title="授業名でサジェストリスト内を検索します">
                </div>
            </div>
            <div class="table-container">
                <table id="manageCoursesTable" class="manage-table">
                    <thead>
                        <tr>
                            <th onclick="sortCourseMaster('grade')" style="cursor: pointer;">学年 <span
                                    id="sortIconGrade">⇅</span></th>
                            <th onclick="sortCourseMaster('course')" style="cursor: pointer;">コース <span
                                    id="sortIconCourse">⇅</span></th>
                            <th onclick="sortCourseMaster('name')" style="cursor: pointer;">授業名 <span
                                    id="sortIconCourseName">⇅</span></th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="manageCoursesBody">
                        <!-- JSで生成 -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="settingsTeachersView" class="settings-tab-content hidden">
            <div class="settings-action-bar"
                style="display: flex; flex-direction: column; gap: 10px; align-items: stretch;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>教員名簿の管理</h3>
                    <button class="btn btn-primary btn-sm" onclick="openTeacherEditModal()"
                        title="新しく教員の名前と情報を名簿に追加します">➕ 新規教員の登録</button>
                </div>
                <div class="search-box">
                    <input type="text" id="teacherMasterSearch" class="form-input" placeholder="氏名や所属で検索..."
                        oninput="renderManageTeachers()">
                </div>
            </div>
            <div class="table-container">
                <table id="manageTeachersTable" class="manage-table">
                    <thead>
                        <tr>
                            <th onclick="sortTeacherMaster('name')" style="cursor: pointer;">氏名 <span
                                    id="sortIconTeacherName">⇅</span></th>
                            <th onclick="sortTeacherMaster('dept')" style="cursor: pointer;">所属/担当 <span
                                    id="sortIconTeacherDept">⇅</span></th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="manageTeachersBody">
                        <!-- JSで生成 -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- 勤務設定セクション (デフォルト非表示) -->
    <section id="workSection" class="card hidden">
        <div class="card-header">
            <div class="card-icon">&#x231B;</div>
            <h2 id="workSettingTitle">勤務パターンの設定</h2>
        </div>

        <div class="work-settings-container" style="padding: 15px;">
            <!-- 勤務パターンの凡例 -->
            <div
                style="background: var(--neutral-50); padding: 20px; border-radius: var(--radius-md); margin-bottom: 30px; border: 1px solid var(--neutral-200); box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);">
                <h3
                    style="font-size: 1.1rem; margin-bottom: 15px; color: var(--neutral-800); display: flex; align-items: center; gap: 10px; font-weight: 700;">
                    <span
                        style="background: var(--primary-blue); color: white; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 0.9rem;">?</span>
                    勤務区分（シフト）の定義
                </h3>
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; font-size: 0.95rem;">
                    <div
                        style="padding: 12px; background: white; border-radius: 6px; border: 1px solid var(--neutral-200); border-left: 5px solid #3b82f6; display: flex; justify-content: space-between;">
                        <span style="font-weight: 700; color: #1e40af;">A勤務</span> <span>08:00 ～ 16:30</span>
                    </div>
                    <div
                        style="padding: 12px; background: white; border-radius: 6px; border: 1px solid var(--neutral-200); border-left: 5px solid #6366f1; display: flex; justify-content: space-between;">
                        <span style="font-weight: 700; color: #3730a3;">B勤務</span> <span>08:45 ～ 17:15</span>
                    </div>
                    <div
                        style="padding: 12px; background: white; border-radius: 6px; border: 1px solid var(--neutral-200); border-left: 5px solid #8b5cf6; display: flex; justify-content: space-between;">
                        <span style="font-weight: 700; color: #5b21b6;">C勤務</span> <span>09:30 ～ 18:00</span>
                    </div>
                    <div
                        style="padding: 12px; background: white; border-radius: 6px; border: 1px solid var(--neutral-200); border-left: 5px solid #a855f7; display: flex; justify-content: space-between;">
                        <span style="font-weight: 700; color: #7e22ce;">D勤務</span> <span>10:30 ～ 19:00</span>
                    </div>
                    <div
                        style="padding: 12px; background: white; border-radius: 6px; border: 1px solid var(--neutral-200); border-left: 5px solid #d946ef; display: flex; justify-content: space-between;">
                        <span style="font-weight: 700; color: #a21caf;">E勤務</span> <span>11:30 ～ 20:00</span>
                    </div>
                    <span style="font-weight: 700; color: var(--neutral-700);">その他</span> <span
                        style="font-size: 0.85rem; color: var(--neutral-500);">自由入力（休憩込8.5h）</span>
                </div>
            </div>
        </div>

        <!-- 期間ごとの設定 -->
        <div id="workPeriodConfigContainer" style="display: grid; gap: 40px;">
            <!-- JavaScriptで各曜日の設定カードが生成される場所 -->
        </div>

        <div style="text-align: center; margin-top: 40px; padding-top: 30px; border-top: 1px solid var(--neutral-200);">
            <button class="btn btn-primary btn-lg" onclick="saveWorkSettings()"
                style="width: 300px; height: 55px; font-size: 1.1rem; box-shadow: var(--shadow-md);">
                <span>&#x1F4BE; 勤務設定を保存する</span>
            </button>
            <p style="margin-top: 12px; font-size: 0.85rem; color: var(--neutral-500);">※ 保存するとカレンダーに反映されます</p>
        </div>
        </div>
    </section>

    <!-- あなたについて（基本情報） -->
    <section id="profileSection" class="card hidden">
        <div class="card-header">
            <div class="card-icon">👤</div>
            <h2>あなたについて（基本情報）</h2>
        </div>
        <div class="card-body">
            <p style="margin-bottom: 20px; color: var(--neutral-600);">申請書作成や勤務管理で使用するあなたの基本情報を登録します。</p>

            <div class="form-grid-profile"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                <div class="profile-item" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <h3 style="font-size: 1rem; margin-bottom: 10px; color: var(--neutral-700);">★ 所属コース</h3>
                        <select id="userCourse" class="form-select" style="width: 100%;">
                            <option value="">選択してください</option>
                            <option value="M">エネルギー機械（M）</option>
                            <option value="D">プロダクトデザイン（D）</option>
                            <option value="E">エレクトロニクス（E）</option>
                            <option value="I">知能情報（I）</option>
                        </select>
                    </div>
                    <div>
                        <h3 style="font-size: 1rem; margin-bottom: 10px; color: var(--neutral-700);">★ 職階</h3>
                        <select id="userRank" class="form-select" style="width: 100%;">
                            <option value="">選択してください</option>
                            <option value="教授">教授</option>
                            <option value="准教授">准教授</option>
                            <option value="講師">講師</option>
                            <option value="助教">助教</option>
                            <option value="非常勤">非常勤</option>
                        </select>
                    </div>
                </div>

                <div class="profile-item">
                    <h3 style="font-size: 1rem; margin-bottom: 10px; color: var(--neutral-700);">★ 職員番号（半角数字）</h3>
                    <input type="text" id="userStaffId" class="form-input" placeholder="例: 123456" style="width: 100%;">
                </div>

                <div class="profile-item">
                    <h3 style="font-size: 1rem; margin-bottom: 10px; color: var(--neutral-700);">★ 氏名</h3>
                    <input type="text" id="userName" class="form-input" placeholder="例: 岡山 太郎" style="width: 100%;">
                </div>

                <div class="profile-item" style="grid-column: 1 / -1;">
                    <h3 style="font-size: 1rem; margin-bottom: 10px; color: var(--neutral-700);">★ 通常担当科目</h3>
                    <p style="font-size: 0.85rem; color: var(--neutral-500); margin-bottom: 8px;">
                        担当している授業を検索して追加してください（複数可）</p>
                    <div style="display: flex; gap: 10px; align-items: center; position: relative;">
                        <input type="text" id="profileSubjectInput" class="form-input" placeholder="科目名を入力して検索..."
                            style="flex: 1;">
                        <button id="addProfileSubjectBtn" class="btn btn-primary" style="white-space: nowrap;">➕
                            追加</button>
                        <div id="profileSubjectSuggestions" class="course-suggestions hidden"
                            style="top: 100%; left: 0; width: 100%;"></div>
                    </div>
                    <div id="profileSubjectsDisplay"
                        style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background: var(--neutral-50); border-radius: var(--radius-md); border: 1px dashed var(--neutral-300); min-height: 50px;">
                        <!-- JSでバッジを表示 -->
                    </div>
                </div>
            </div>

            <div
                style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--neutral-200); text-align: right;">
                <button id="saveProfileBtn" class="btn btn-primary"
                    style="padding: 10px 30px; font-weight: 700; box-shadow: var(--shadow-md);">上記の内容で保存する</button>
            </div>
        </div>
    </section>

    <!-- ヘルプセクション -->
    <section id="helpSection" class="card hidden">
        <div class="card-header">
            <div class="card-icon">❓</div>
            <h2>アプリの使い方ガイド & 機能詳細</h2>
        </div>
        <div class="help-content">
            <div class="help-grid">
                <div class="help-item">
                    <h3>📅 カレンダーの操作</h3>
                    <p>マウスやタッチ操作で直感的にスケジュールを管理できます。</p>
                    <ul>
                        <li><strong>行事クリック:</strong> 詳細の確認や編集ができます。</li>
                        <li><strong>右クリック（長押し）:</strong> 参加/非参加の切替、イベントのコピー・移動・削除が可能です。</li>
                        <li><strong>ドラッグ＆ドロップ:</strong> 予定を掴んで別の日付へ移動したり、コピー（Altキー併用）したりできます。</li>
                        <li><strong>空きスペース右クリック:</strong> 年休や出張のクイック登録、オリジナル予定の追加ができます。</li>
                    </ul>
                </div>
                <div class="help-item">
                    <h3>📝 授業・名簿の登録</h3>
                    <p>入力の手間を省くための強力な補助機能があります。</p>
                    <ul>
                        <li><strong>教員の割当:</strong> 授業編集画面で、教員リストからドラッグ＆ドロップで担当者を追加できます。</li>
                        <li><strong>時間割の一括作成:</strong> 学校のExcel等から教員名リストをコピーし、本アプリの教員管理でまとめて貼り付け登録が可能です。</li>
                        <li><strong>振替自動追従:</strong> 授業を登録しておけば、Excel取込された「曜日カウント」に従い、振替授業日にも自動で予定が表示されます。</li>
                    </ul>
                </div>
                <div class="help-item">
                    <h3>📄 対応している申請・統計</h3>
                    <p>「勤怠管理」メニューから以下の状況を一覧・集計できます。</p>
                    <ul>
                        <li><strong>休暇類:</strong> 年次有給休暇（全日・半日・時間単位）、特別休暇、病気休暇など。</li>
                        <li><strong>業務類:</strong> 出張（宿泊対応）、在宅勤務（テレワーク）、休日出勤。</li>
                        <li><strong>振替休日:</strong> 休日出勤時の振替希望日と、その消化状況の管理。</li>
                        <li><strong>自動提案:</strong> 授業時間に合わせて、A~Eの勤務シフトをAIが自動的に推奨します。</li>
                    </ul>
                </div>
                <div class="help-item">
                    <h3>💾 データとエクスポート</h3>
                    <p>作成した予定を外部サービスやファイルと共有します。</p>
                    <ul>
                        <li><strong>iCalエクスポート:</strong> GoogleカレンダーやiPhone等にスケジュールを同期できます。</li>
                        <li><strong>CSV出力:</strong> 期間を指定して、行事・授業・申請内容をExcel等で開ける形式で出力します。</li>
                        <li><strong>自動保存:</strong> 入力内容はブラウザに即時保存されます。端末を替える際は「ファイル操作」からバックアップを取得してください。</li>
                    </ul>
                </div>
                <div class="help-item">
                    <h3>⚠️ 予定の重複警告</h3>
                    <p>カレンダーに表示される警告マークの判定ルールです。アイコンにマウスを合わせると重複の詳細が表示されます。</p>
                    <table
                        style="width:100%; font-size:0.85rem; border-collapse:collapse; margin-top:10px; border:1px solid var(--neutral-200); border-radius:4px;">
                        <tr style="background:var(--neutral-50); border-bottom:1px solid var(--neutral-200);">
                            <th style="padding:8px; text-align:left;">組み合わせ</th>
                            <th style="padding:8px; text-align:left;">⚠️が表示される条件</th>
                        </tr>
                        <tr style="border-bottom:1px solid var(--neutral-100);">
                            <td style="padding:8px;">時間指定 vs 時間指定</td>
                            <td style="padding:8px;">物理的に時間帯が重なっている場合</td>
                        </tr>
                        <tr style="border-bottom:1px solid var(--neutral-100);">
                            <td style="padding:8px;">出張 vs 📌付き行事/授業</td>
                            <td style="padding:8px;">日付が重なっている場合（終日でも警告）</td>
                        </tr>
                        <tr style="border-bottom:1px solid var(--neutral-100);">
                            <td style="padding:8px;">在宅勤務 vs 📌付き行事/授業</td>
                            <td style="padding:8px;">日付が重なっている場合（終日でも警告）</td>
                        </tr>
                        <tr style="border-bottom:1px solid var(--neutral-100);">
                            <td style="padding:8px;">終日📌行事 vs 時間指定授業</td>
                            <td style="padding:8px;">出張・在宅でない限り、警告は出ません</td>
                        </tr>
                        <tr>
                            <td style="padding:8px;">終日行事 vs 終日行事</td>
                            <td style="padding:8px;">通常の行事同士であれば、警告は出ません</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- 勤怠管理表示 -->
    <section id="statsView" class="card hidden">
        <div class="card-header">
            <div class="card-icon">📊</div>
            <h2 id="statsTitle">勤怠管理・統計</h2>
        </div>
        <div class="card-body" style="padding: 20px;">
            <div class="stats-summary"
                style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-label">年休合計(推計)</div>
                    <div id="statLeaveTotal" class="stat-value" style="font-size: 1.2rem;">0日分</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">出張回数</div>
                    <div id="statTripTotal" class="stat-value">0回</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">在宅勤務</div>
                    <div id="statWfhTotal" class="stat-value">0日</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">休日出勤</div>
                    <div id="statHolidayWorkTotal" class="stat-value">0回</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">パターン変更</div>
                    <div id="statShiftChangeTotal" class="stat-value">0回</div>
                </div>
            </div>

            <div class="stats-filters"
                style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; background: var(--neutral-50); padding: 15px; border-radius: 8px; border: 1px solid var(--neutral-200);">
                <div class="filter-group">
                    <label for="statsFilterPeriod" style="font-weight: 600; margin-right: 8px; font-size: 0.9rem;">📅
                        表示期間:</label>
                    <select id="statsFilterPeriod" class="form-select" onchange="renderApplicationStats()"
                        style="width: auto; padding: 5px 10px; font-size: 0.9rem;">
                        <option value="calendar_year" selected>年休集計期間 (1月-12月)</option>
                        <option value="all">全期間 (年度内: 4月-3月)</option>
                        <optgroup label="月別 (カレンダー年)">
                            <option value="month-1">1月</option>
                            <option value="month-2">2月</option>
                            <option value="month-3">3月</option>
                            <option value="month-4">4月</option>
                            <option value="month-5">5月</option>
                            <option value="month-6">6月</option>
                            <option value="month-7">7月</option>
                            <option value="month-8">8月</option>
                            <option value="month-9">9月</option>
                            <option value="month-10">10月</option>
                            <option value="month-11">11月</option>
                            <option value="month-12">12月</option>
                        </optgroup>
                        <optgroup label="学期・四半期">
                            <option value="first_half">前期 (4月-9月)</option>
                            <option value="second_half">後期 (10月-3月)</option>
                        </optgroup>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="statsFilterType" style="font-weight: 600; margin-right: 8px; font-size: 0.9rem;">🔍
                        種別:</label>
                    <select id="statsFilterType" class="form-select" onchange="renderApplicationStats()"
                        style="width: auto; padding: 5px 10px; font-size: 0.9rem;">
                        <option value="all">すべて</option>
                        <option value="leave">年休</option>
                        <option value="trip">出張</option>
                        <option value="wfh">在宅勤務</option>
                        <option value="holiday-work">休日出勤</option>
                        <option value="shift">勤務変更</option>
                    </select>
                </div>
                <div style="flex: 1;"></div>
                <div class="table-actions">
                    <button class="btn btn-outline-primary" onclick="exportApplicationStatsCsv()">
                        <span>📂 CSV出力</span>
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="manage-table">
                    <thead>
                        <tr>
                            <th style="width: 120px; cursor: pointer;" onclick="sortApplicationStats('date')">日付 <span
                                    id="sortIconStatsDate">⇅</span></th>
                            <th style="width: 100px; cursor: pointer;" onclick="sortApplicationStats('type')">種類 <span
                                    id="sortIconStatsType">⇅</span></th>
                            <th style="width: 200px;">内容 / 用務先</th>
                            <th>時間 / 条件</th>
                            <th style="width: 120px; cursor: pointer;" onclick="sortApplicationStats('status')">申請状況
                                <span id="sortIconStatsStatus">⇅</span>
                            </th>
                            <th style="width: 180px;">操作</th>
                        </tr>
                    </thead>
                    <tbody id="applicationStatsBody">
                        <!-- JSで生成 -->
                    </tbody>
                </table>
            </div>

            <div class="stats-application-actions"
                style="margin-top: 30px; padding: 20px; background: rgba(99, 102, 241, 0.05); border-radius: var(--radius-lg); border: 1px solid rgba(99, 102, 241, 0.1);">
                <h3
                    style="font-size: 1.1rem; margin-bottom: 20px; color: var(--neutral-700); display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.4rem;">📝</span> 変更申請・書類作成
                </h3>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="generateApplicationFile('shift')"
                        style="background: var(--neutral-700); border-color: var(--neutral-700);">
                        <span>🔄 勤務パターン変更</span>
                    </button>
                    <button class="btn btn-primary" onclick="generateApplicationFile('wfh_pre')"
                        style="background: var(--success-green); border-color: var(--success-green);">
                        <span>🏠 在宅勤務 (事前)</span>
                    </button>
                    <button class="btn btn-primary" onclick="generateApplicationFile('wfh_post')"
                        style="background: #059669; border-color: #059669;">
                        <span>🏠 在宅勤務 (事後)</span>
                    </button>
                    <button class="btn btn-primary" onclick="generateApplicationFile('holiday_work')"
                        style="background: var(--warning-orange); border-color: var(--warning-orange);">
                        <span>📅 休日出勤</span>
                    </button>
                    <button class="btn btn-primary" onclick="generateApplicationFile('trip')"
                        style="background: var(--primary-blue); border-color: var(--primary-blue);">
                        <span>✈️ 出張</span>
                    </button>
                </div>
                <p style="margin-top: 15px; font-size: 0.85rem; color: var(--neutral-500);">※
                    「あなたについて」で設定した基本情報が自動的に記入されます。</p>
            </div>
        </div>
    </section>
    </div>



    <!-- 教員リストサジェスト（D&D用） - 共通で使用できるように外側に配置 -->
    <div id="teacherListContainer" class="teacher-list-container hidden">
        <div class="teacher-list-header">
            <span>教員リスト</span>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="teacherSearchInput" placeholder="検索..." class="form-input"
                    style="padding: 2px 5px; font-size: 0.8rem; height: 25px;">
                <button type="button" onclick="closeTeacherList()">&times;</button>
            </div>
        </div>
        <div id="teacherListItems" class="teacher-list-items">
            <!-- JSで生成 -->
        </div>
    </div>

    <!-- 授業登録・編集モーダル -->
    <div id="classInputModal" class="modal hidden">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2>授業の登録・編集</h2>
                <button class="close-modal-btn" onclick="closeClassInputModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- 授業入力フォーム (移動) -->
                <div class="class-input-form">
                    <div class="form-section">
                        <h3 class="form-section-title">基本情報</h3>

                        <!-- 授業名 -->
                        <div class="form-row-single">
                            <div class="form-group form-group-full" style="position: relative;">
                                <label for="className">授業名 <span class="required">*</span></label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <select id="courseFilterSelect" class="form-select"
                                        style="width: auto; padding: 8px; font-size: 0.85rem; min-width: 100px;">
                                        <option value="all">全検索</option>
                                        <option value="common">共通</option>
                                        <option value="M">M (機)</option>
                                        <option value="D">D (デ)</option>
                                        <option value="E">E (電)</option>
                                        <option value="I">I (情)</option>
                                    </select>
                                    <input type="text" id="className" placeholder="例：データ構造とアルゴリズム" class="form-input"
                                        style="flex: 1;">
                                    <button id="searchCourseBtn" class="btn btn-outline-primary btn-sm"
                                        style="padding: 8px 12px; white-space: nowrap;" title="科目一覧から検索">&#x1F50D;
                                        検索</button>
                                </div>
                                <div id="courseSuggestions" class="course-suggestions hidden"></div>
                            </div>
                        </div>

                        <!-- 場所 -->
                        <div class="form-row-single">
                            <div class="form-group form-group-full">
                                <label for="classLocation">場所</label>
                                <input type="text" id="classLocation" placeholder="例：情報処理演習室1" class="form-input">
                            </div>
                        </div>

                        <!-- 担当教員セクション -->
                        <div
                            style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(99, 102, 241, 0.15);">
                            <div class="form-row-single">
                                <div class="form-group form-group-full" style="position: relative;">
                                    <label for="classTeacher">担当教員（複数可・最大10人）
                                        <span id="teacherCountBadge"
                                            style="display: none; margin-left: 8px; padding: 2px 8px; background: var(--primary-blue); color: white; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">0人</span>
                                    </label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="text" id="classTeacher" placeholder="教員名を入力（ドラッグ＆ドロップ可）"
                                            class="form-input" style="flex: 1;">
                                        <button type="button" id="toggleTeacherListBtn"
                                            class="btn btn-outline-secondary btn-sm"
                                            style="padding: 8px 12px; white-space: nowrap;" title="教員リストを表示">&#x1F465;
                                            リスト</button>
                                        <button type="button" id="addTeacherBtn" class="btn btn-outline-primary btn-sm"
                                            style="padding: 8px 12px; white-space: nowrap;" title="教員を追加">➕ 追加</button>
                                    </div>
                                    <div id="teacherSuggestions" class="course-suggestions hidden"></div>
                                </div>
                            </div>

                            <!-- 担当教員リスト -->
                            <div id="selectedTeachersList"
                                style="margin-top: 1rem; padding: 1rem; background: rgba(99, 102, 241, 0.05); border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.15); min-height: 60px;">
                                <div id="teachersDisplay"
                                    style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 40px; align-content: flex-start;">
                                    <div class="empty-teacher-message"
                                        style="width: 100%; color: var(--neutral-500); font-size: 0.85rem;">教員を追加してください
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="form-section">
                        <h3 class="form-section-title">対象クラス</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="classYear">開講年度 <span class="required">*</span></label>
                                <select id="classYear" class="form-select">
                                    <!-- JSで生成 -->
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="departmentType">課程 <span class="required">*</span></label>
                                <select id="departmentType" class="form-select">
                                    <option value="teacher">本科</option>
                                    <option value="student">専攻科</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="targetType">展開方法 <span class="required">*</span></label>
                                <select id="targetType" class="form-select">
                                    <option value="class">クラス別</option>
                                    <option value="grade">学年全体</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="targetGrade">学年 <span class="required">*</span></label>
                                <select id="targetGrade" class="form-select">
                                    <option value="1">1年</option>
                                    <option value="2">2年</option>
                                    <option value="3">3年</option>
                                    <option value="4">4年</option>
                                    <option value="5">5年</option>
                                </select>
                            </div>

                            <div class="form-group" id="targetClassGroup">
                                <label for="targetClass">クラス <span class="required">*</span></label>
                                <select id="targetClass" class="form-select">
                                    <option value="1">1組</option>
                                    <option value="2">2組</option>
                                    <option value="3">3組</option>
                                    <option value="4">4組</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="form-section-title">時間割</h3>

                        <div class="form-row" style="margin-bottom: 1rem;">
                            <div class="form-group">
                                <label for="semesterType">開講期間 <span class="required">*</span></label>
                                <select id="semesterType" class="form-select">
                                    <option value="full">通年</option>
                                    <option value="first">前期のみ</option>
                                    <option value="second">後期のみ</option>
                                </select>
                            </div>
                        </div>

                        <div class="semester-schedule">
                            <div class="semester-group" id="firstSemesterGroup">
                                <h4>前期</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="firstWeekday">曜日 <span class="required">*</span></label>
                                        <select id="firstWeekday" class="form-select">
                                            <option value="1">月曜日</option>
                                            <option value="2">火曜日</option>
                                            <option value="3">水曜日</option>
                                            <option value="4">木曜日</option>
                                            <option value="5">金曜日</option>
                                            <option value="6">土曜日</option>
                                            <option value="0">日曜日</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="firstPeriod">時限 <span class="required">*</span></label>
                                        <select id="firstPeriod" class="form-select">
                                            <option value="1">1限 (9:00-10:35)</option>
                                            <option value="1-2">1限～2限 (9:00-12:20)</option>
                                            <option value="1-3">1限～3限 (9:00-14:40)</option>
                                            <option value="1-4">1限～4限 (9:00-16:25)</option>
                                            <option value="2">2限 (10:45-12:20)</option>
                                            <option value="2-3">2限～3限 (10:45-14:40)</option>
                                            <option value="2-4">2限～4限 (10:45-16:25)</option>
                                            <option value="3">3限 (13:05-14:40)</option>
                                            <option value="3-4">3限～4限 (13:05-16:25)</option>
                                            <option value="HR">HR (14:50-15:35)</option>
                                            <option value="4">4限 (14:50-16:25)</option>
                                            <option value="after">放課後</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="semester-group" id="secondSemesterGroup">
                                <h4>後期</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="secondWeekday">曜日 <span class="required">*</span></label>
                                        <select id="secondWeekday" class="form-select">
                                            <option value="1">月曜日</option>
                                            <option value="2">火曜日</option>
                                            <option value="3">水曜日</option>
                                            <option value="4">木曜日</option>
                                            <option value="5">金曜日</option>
                                            <option value="6">土曜日</option>
                                            <option value="0">日曜日</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="secondPeriod">時限 <span class="required">*</span></label>
                                        <select id="secondPeriod" class="form-select">
                                            <option value="1">1限 (9:00-10:35)</option>
                                            <option value="1-2">1限～2限 (9:00-12:20)</option>
                                            <option value="1-3">1限～3限 (9:00-14:40)</option>
                                            <option value="1-4">1限～4限 (9:00-16:25)</option>
                                            <option value="2">2限 (10:45-12:20)</option>
                                            <option value="2-3">2限～3限 (10:45-14:40)</option>
                                            <option value="2-4">2限～4限 (10:45-16:25)</option>
                                            <option value="3">3限 (13:05-14:40)</option>
                                            <option value="3-4">3限～4限 (13:05-16:25)</option>
                                            <option value="HR">HR (14:50-15:35)</option>
                                            <option value="4">4限 (14:50-16:25)</option>
                                            <option value="after">放課後</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <input type="hidden" id="editingClassId">
                        <button id="cancelEditBtn" class="btn btn-secondary hidden" style="margin-right: 10px;">
                            <span>❌ キャンセル</span>
                        </button>
                        <button id="addClassBtn" class="btn btn-primary" style="width: 100%;">
                            <span>➕ 授業を保存</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding-top: 0; border: none;">
                <!-- フッターなしでもOK -->
            </div>
        </div>
    </div>

    <!-- 予定・授業の個別編集モーダル -->
    <div id="quickEditModal" class="modal hidden">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2 id="quickEditModalTitle">予定の編集（この日のみ）</h2>
                <button class="close-modal-btn" onclick="closeQuickEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="quickEditForm" onsubmit="handleQuickEditSubmit(event)">
                    <input type="hidden" id="quickEditType">
                    <input type="hidden" id="quickEditId">
                    <input type="hidden" id="quickEditDate">
                    <input type="hidden" id="quickEditSourcePeriod">



                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="quickEditName">内容 / 授業名</label>
                        <input type="text" id="quickEditName" class="form-input" required>
                    </div>

                    <div style="display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap;">
                        <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
                            <input type="checkbox" id="quickEditAllDay" onchange="toggleQuickEditTimeFields()">
                            <label for="quickEditAllDay" style="margin-bottom: 0;">終日</label>
                        </div>
                        <div id="quickEditParticipateFields" class="form-group"
                            style="flex-direction: row; align-items: center; gap: 10px;">
                            <input type="checkbox" id="quickEditParticipate">
                            <label for="quickEditParticipate" style="margin-bottom: 0;">📌 ピン止め</label>
                        </div>
                        <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
                            <input type="checkbox" id="quickEditApplied">
                            <label for="quickEditApplied" style="margin-bottom: 0;">📄 申請済み</label>
                        </div>
                    </div>

                    <div id="quickEditDateRangeFields" class="hidden"
                        style="padding: 12px; background: var(--neutral-50); border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--neutral-100);">
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div
                                style="display: grid; grid-template-columns: auto 1fr 120px; align-items: center; gap: 10px;">
                                <span style="font-size: 0.85rem; font-weight: 600; width: 40px;">開始:</span>
                                <input type="date" id="quickEditStartDate" class="form-input" style="padding: 5px;">
                                <div id="quickEditStartTimeWrapper">
                                    <input type="time" id="quickEditStartTime" class="form-input" style="padding: 5px;"
                                        oninput="syncQuickTime(this, 'start')">
                                </div>
                            </div>
                            <div
                                style="display: grid; grid-template-columns: auto 1fr 120px; align-items: center; gap: 10px;">
                                <span style="font-size: 0.85rem; font-weight: 600; width: 40px;">終了:</span>
                                <input type="date" id="quickEditEndDate" class="form-input" style="padding: 5px;">
                                <div id="quickEditEndTimeWrapper">
                                    <input type="time" id="quickEditEndTime" class="form-input" style="padding: 5px;"
                                        oninput="syncQuickTime(this, 'end')">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="quickEditTimeFields" class="hidden">
                        <div id="quickEditClassOnlyFields" class="hidden">
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="quickEditPeriod">時限</label>
                                <select id="quickEditPeriod" class="form-select" onchange="updateQuickTimeFromPeriod()">
                                    <option value="1">1限 (9:00-10:35)</option>
                                    <option value="1-2">1限～2限 (9:00-12:20)</option>
                                    <option value="1-3">1限～3限 (9:00-14:40)</option>
                                    <option value="1-4">1限～4限 (9:00-16:25)</option>
                                    <option value="2">2限 (10:45-12:20)</option>
                                    <option value="2-3">2限～3限 (10:45-14:40)</option>
                                    <option value="2-4">2限～4限 (10:45-16:25)</option>
                                    <option value="3">3限 (13:05-14:40)</option>
                                    <option value="3-4">3限～4限 (13:05-16:25)</option>
                                    <option value="HR">HR (14:50-15:35)</option>
                                    <option value="4">4限 (14:50-16:25)</option>
                                    <option value="after">放課後</option>
                                </select>
                            </div>
                        </div>

                        <!-- 単一日の時刻（quickEditDateRangeFieldsが隠れている時に使用） -->
                        <div id="quickEditSingleTimeFields"
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label for="quickEditStartTime_Single">開始時刻</label>
                                <input type="time" id="quickEditStartTime_Single" class="form-input"
                                    oninput="syncQuickTime(this, 'start')">
                            </div>
                            <div class="form-group">
                                <label for="quickEditEndTime_Single">終了時刻</label>
                                <input type="time" id="quickEditEndTime_Single" class="form-input"
                                    oninput="syncQuickTime(this, 'end')">
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="quickEditLocation">場所</label>
                        <input type="text" id="quickEditLocation" class="form-input">
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="quickEditMemo">メモ（iCalの詳細はここに出力されます）</label>
                        <textarea id="quickEditMemo" class="form-input"
                            style="min-height: 80px; resize: vertical;"></textarea>
                    </div>

                    <div style="margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeQuickEditModal()">キャンセル</button>
                        <button type="submit" class="btn btn-primary" style="padding-left: 30px; padding-right: 30px;">
                            <span>&#x1F4BE; 保存</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 教員追加・編集モーダル -->
    <div id="teacherEditModal" class="modal hidden">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="teacherEditModalTitle">教員の追加/編集</h2>
                <button class="close-modal-btn" onclick="closeTeacherEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editingTeacherIndex">
                <div class="form-group">
                    <label for="editTeacherName">氏名 <span class="required">*</span></label>
                    <input type="text" id="editTeacherName" class="form-input" placeholder="例：山田　太郎">
                </div>
                <div class="form-group">
                    <label for="editTeacherDept">所属 / コース</label>
                    <input type="text" id="editTeacherDept" class="form-input" placeholder="例：知能情報">
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-secondary" style="flex: 1;" onclick="closeTeacherEditModal()">キャンセル</button>
                    <button class="btn btn-primary" style="flex: 1;" onclick="saveTeacher()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 候補授業（マスター）追加・編集モーダル -->
    <div id="courseEditModal" class="modal hidden">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="courseEditModalTitle">候補授業の追加/編集</h2>
                <button class="close-modal-btn" onclick="closeCourseEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editingCourseIndex">
                <div class="form-group">
                    <label for="editCourseName">授業名 <span class="required">*</span></label>
                    <input type="text" id="editCourseName" class="form-input" placeholder="例：応用数学A">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="editCourseGrade">学年</label>
                        <select id="editCourseGrade" class="form-select">
                            <option value="1">1年</option>
                            <option value="2">2年</option>
                            <option value="3">3年</option>
                            <option value="4">4年</option>
                            <option value="5">5年</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editCourseDept">コース</label>
                        <select id="editCourseDept" class="form-select">
                            <option value="common">一般/共通</option>
                            <option value="M">M (エネルギー機械)</option>
                            <option value="D">D (プロダクトデザイン)</option>
                            <option value="E">E (エレクトロニクス)</option>
                            <option value="I">I (知能情報)</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-secondary" style="flex: 1;" onclick="closeCourseEditModal()">キャンセル</button>
                    <button class="btn btn-primary" style="flex: 1;" onclick="saveCourseMaster()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 授業日程表表示モーダル -->
    <div id="classScheduleModal" class="modal hidden">
        <div class="modal-content" style="max-width: 1000px; width: 95%;">
            <div class="modal-header">
                <h2>授業日程表</h2>
                <button class="close-modal-btn" onclick="closeClassScheduleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="filterControlsContainer" class="filter-controls"
                    style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; display: flex; gap: 20px; align-items: center;">
                    <span style="font-weight: bold; font-size: 0.9rem;">表示対象:</span>
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="filterAnnualEvents" checked> 年間行事
                    </label>
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="filterMyClasses" checked> 授業
                    </label>
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; margin-right: 15px;">
                    </label>
                </div>
                <div id="classScheduleContent">
                    <table class="schedule-table table-container manage-table">
                        <thead>
                            <!-- JSで動的生成 -->
                        </thead>
                        <tbody id="classScheduleBody">
                            <!-- JSで動的生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button id="csvExportScheduleBtn" class="btn btn-outline-primary">
                    <span>&#x1F4C4; CSV出力</span>
                </button>
                <button id="printScheduleBtn" class="btn btn-primary">
                    <span>&#x1F5A8;️ 印刷する</span>
                </button>
                <button class="btn btn-outline-primary" onclick="exportToCsv()" title="現在の表示内容をCSV形式で保存します">
                    <span>&#x1F4C4; CSV出力</span>
                </button>
                <button class="btn btn-secondary" onclick="closeClassScheduleModal()">閉じる</button>
            </div>
        </div>
    </div>


    </div>
    </div>
    </div>

    <!-- 年休申請モーダル -->
    <div id="annualLeaveModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>&#x1F343; 年休の登録</h2>
                <button class="close-modal-btn" onclick="closeAnnualLeaveModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="leaveDateLabel" style="font-weight: 700; margin-bottom: 10px; color: var(--neutral-600);">日付:
                    2026/02/14</div>
                <div id="leaveWorkTimeLabel"
                    style="font-size: 0.85rem; color: var(--neutral-400); margin-bottom: 20px;">勤務時間: 08:30 ～ 17:00
                </div>

                <div class="form-group">
                    <label>休暇の種類を選択</label>
                    <div id="leaveOptionsList" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- JSで動的に生成 -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAnnualLeaveModal()">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- 出張申請モーダル -->
    <div id="businessTripModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>&#x1F4BC; 出張の登録</h2>
                <button class="close-modal-btn" onclick="closeBusinessTripModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group"
                    style="padding: 15px; background: var(--neutral-50); border-radius: 8px; border: 1px solid var(--neutral-100); margin-bottom: 20px;">
                    <label
                        style="color: var(--primary-600); font-weight: 700; margin-bottom: 12px; display: block; font-size: 0.95rem;">期間設定</label>

                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- 出発 -->
                        <div
                            style="display: grid; grid-template-columns: auto 1fr 120px; align-items: center; gap: 10px;">
                            <span style="font-weight: 600; font-size: 0.85rem; width: 40px;">出発:</span>
                            <input type="date" id="tripStartDate" class="form-input" style="padding: 6px;">
                            <input type="time" id="tripDepartureTime" class="form-input" style="padding: 6px;">
                        </div>

                        <!-- 到着 -->
                        <div
                            style="display: grid; grid-template-columns: auto 1fr 120px; align-items: center; gap: 10px;">
                            <span style="font-weight: 600; font-size: 0.85rem; width: 40px;">帰着:</span>
                            <input type="date" id="tripEndDate" class="form-input" style="padding: 6px;">
                            <input type="time" id="tripArrivalTime" class="form-input" style="padding: 6px;">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="tripDestination">用務先 <span class="required">*</span></label>
                    <input type="text" id="tripDestination" class="form-input" placeholder="例：東京大学">
                </div>

                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label style="font-size: 0.85rem; font-weight: 600;">出発地</label>
                        <select id="tripDeparturePoint" class="form-select" style="padding: 6px;">
                            <option value="school">学校発</option>
                            <option value="home">自宅発</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.85rem; font-weight: 600;">帰先</label>
                        <select id="tripArrivalPoint" class="form-select" style="padding: 6px;">
                            <option value="home">自宅着</option>
                            <option value="school">学校着</option>
                        </select>
                    </div>
                </div>
                <p style="font-size: 0.75rem; color: var(--neutral-400); margin-top: 5px;">※
                    学校発/学校着の場合は、指定時刻まで/以降が通常勤務となります。</p>
                <div class="form-group"
                    style="padding: 0 5px; margin-top: 15px; border-top: 1px solid var(--neutral-100); padding-top: 15px;">
                    <label style="flex-direction: row; align-items: center; gap: 8px; display: flex; cursor: pointer;">
                        <input type="checkbox" id="tripApplied">
                        <span style="font-weight: 500;">📄 事務担当へ申請済み</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBusinessTripModal()">キャンセル</button>
                <button class="btn btn-primary" onclick="saveBusinessTrip()">OK</button>
            </div>
        </div>
    </div>

    <!-- 在宅勤務モーダル -->
    <div id="wfhModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>&#x1F3E1; 在宅勤務の登録</h2>
                <button class="close-modal-btn" onclick="closeWfhModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="wfhDateLabel" style="font-weight: 700; margin-bottom: 15px; color: var(--neutral-600);">日付:
                    2026/02/14</div>

                <div class="form-group">
                    <label for="wfhLocation">場所</label>
                    <input type="text" id="wfhLocation" class="form-input" placeholder="例：自宅" value="自宅">
                </div>

                <div class="form-group">
                    <label>時間範囲</label>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <input type="checkbox" id="wfhAllDay" checked onchange="toggleWfhTimeFields()">
                        <label for="wfhAllDay"
                            style="font-size: 0.9rem; font-weight: normal; margin-bottom: 0;">終日</label>
                    </div>
                    <div id="wfhTimeFields" class="hidden" style="display: flex; align-items: center; gap: 10px;">
                        <input type="time" id="wfhStartTime" class="form-input" style="width: auto;">
                        <span>～</span>
                        <input type="time" id="wfhEndTime" class="form-input" style="width: auto;">
                    </div>
                </div>
                <div class="form-group"
                    style="padding: 0 5px; margin-top: 15px; border-top: 1px solid var(--neutral-100); padding-top: 15px;">
                    <label style="flex-direction: row; align-items: center; gap: 8px; display: flex; cursor: pointer;">
                        <input type="checkbox" id="wfhApplied">
                        <span style="font-weight: 500;">📄 事務担当へ申請済み</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeWfhModal()">キャンセル</button>
                <button class="btn btn-primary" onclick="saveWfh()">OK</button>
            </div>
        </div>
    </div>

    <!-- 休日出勤モーダル -->
    <div id="holidayWorkModal" class="modal hidden">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h2>&#x1F4BC; 休日出勤の登録</h2>
                <button class="close-modal-btn" onclick="closeHolidayWorkModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="holidayWorkDateLabel"
                    style="font-weight: 700; margin-bottom: 15px; color: var(--neutral-600);">日付: 2026/02/14</div>

                <div class="form-group">
                    <label>時間範囲 <span class="required">*</span></label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="time" id="holidayWorkStartTime" class="form-input" value="09:00">
                        <span>～</span>
                        <input type="time" id="holidayWorkEndTime" class="form-input" value="17:00">
                    </div>
                    <p style="font-size: 0.75rem; color: var(--neutral-500); margin-top: 5px;">※
                        4時間以上従事する場合、45分の休憩が自動算出されます。</p>
                </div>

                <div class="form-group">
                    <label for="holidayWorkContent">業務内容 <span class="required">*</span></label>
                    <input type="text" id="holidayWorkContent" class="form-input" placeholder="例：オープンキャンパス対応">
                </div>

                <div class="form-group">
                    <label>振替希望（任意入力）</label>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <input type="date" id="holidayWorkSubstituteDate" class="form-input">
                        <select id="holidayWorkSubstituteType" class="form-select" style="width: auto;">
                            <option value="full">全日</option>
                            <option value="early">半日（前半）</option>
                            <option value="late">半日（後半）</option>
                        </select>
                    </div>
                </div>

                <div class="form-group"
                    style="padding: 0 5px; margin-top: 15px; border-top: 1px solid var(--neutral-100); padding-top: 15px;">
                    <label style="flex-direction: row; align-items: center; gap: 8px; display: flex; cursor: pointer;">
                        <input type="checkbox" id="holidayWorkApplied">
                        <span style="font-weight: 500;">📄 事務担当へ申請済み</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeHolidayWorkModal()">キャンセル</button>
                <button class="btn btn-primary" onclick="saveHolidayWork()">OK</button>
            </div>
        </div>
    </div>

    <!-- 年休候補日表示モーダル (RESTORED) -->
    <div id="vacationCandidateModal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px; width: 95%;">
            <div class="modal-header">
                <h2>&#x1F3D6;️ 年休候補日一覧</h2>
                <button class="close-modal-btn" onclick="closeVacationCandidateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 10px; font-size: 0.9rem; color: #666;">
                    ※ ピン留め（&#x1F4CC;）されていない営業日（月〜金、および補講日）を抽出しています。祝日は除外されています。
                </p>
                <div class="schedule-table-container">
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th style="width: 120px;">日付</th>
                                <th style="width: 60px;">曜</th>
                                <th>参考行事</th>
                                <th>状況・備考</th>
                            </tr>
                        </thead>
                        <tbody id="vacationCandidateBody">
                            <!-- JSで生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button id="csvExportVacationBtn" class="btn btn-outline-success">
                    <span>&#x1F4C4; CSV出力</span>
                </button>
                <button id="printVacationCandidateBtn" class="btn btn-success">
                    <span>&#x1F5A8;️ 印刷する</span>
                </button>
                <button class="btn btn-secondary" onclick="closeVacationCandidateModal()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- ローディングオーバーレイ -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>処理中...</p>
        </div>
    </div>

    <!-- 右クリックコンテキストメニュー -->
    <div id="calendarContextMenu" class="context-menu hidden">
        <ul class="context-menu-list">
            <li id="ctxParticipate" onclick="handleContextAction('participate')">&#x1F4CC; 参加にする</li>
            <li id="ctxNotParticipate" onclick="handleContextAction('not_participate')">&#x1F6AB; 非参加にする</li>
            <li class="divider"></li>
            <li onclick="handleContextAction('edit')">✏️ 編集...</li>
            <li onclick="handleContextAction('delete')" style="color: var(--error-red);">&#x1F5D1;️ 削除</li>
        </ul>
    </div>

    </div>

    <!-- メインスクリプト -->
    <script src="app.js"></script>
    <script src="my_classes.js"></script>
    <script src="profile.js"></script>
    <script src="templates_content.js"></script>
    <script src="applications.js"></script>
</body>

</html>